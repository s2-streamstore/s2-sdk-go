name: CI
permissions:
  contents: read
on:
  pull_request:
  push:
    branches:
      - main

env:
  CLICOLOR: 1

concurrency:
  group: "${{ github.workflow }}-${{ github.ref }}"
  cancel-in-progress: true

jobs:
  ci:
    permissions:
      contents: none
    name: CI
    needs: [examples, test, s2-integration, s2-lite-integration, golangci-lint, bento-integration]
    runs-on: ubuntu-latest
    if: always()
    steps:
      - name: Failed
        run: exit 1
        if: contains(needs.*.result, 'failure') || contains(needs.*.result, 'cancelled') || contains(needs.*.result, 'skipped')

  examples:
    name: Build examples
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: true
      - uses: actions/setup-go@v5
        with:
          go-version: "1.23"
      - uses: arduino/setup-task@v2
        with:
          version: 3.40.x
          repo-token: ${{ secrets.GITHUB_TOKEN }}
      - uses: arduino/setup-protoc@v3
        with:
          version: 29.3
          repo-token: ${{ secrets.GITHUB_TOKEN }}
      - name: Setup protoc
        run: go install google.golang.org/protobuf/cmd/protoc-gen-go@v1.36.10
      - name: Build
        run: |
          for eg in `go list ./examples/... | sed 's|.*/||'`; do
            echo "Building '$eg' example"
            task eg:build NAME=$eg
          done

  test:
    name: Test
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: true
      - uses: actions/setup-go@v5
        with:
          go-version: "1.23"
      - uses: arduino/setup-task@v2
        with:
          version: 3.40.x
          repo-token: ${{ secrets.GITHUB_TOKEN }}
      - uses: arduino/setup-protoc@v3
        with:
          version: 29.3
          repo-token: ${{ secrets.GITHUB_TOKEN }}
      - name: Setup protoc
        run: go install google.golang.org/protobuf/cmd/protoc-gen-go@v1.36.10
      - name: Test
        run: task test

  s2-integration:
    name: S2 Integration
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: true
      - uses: actions/setup-go@v5
        with:
          go-version: "1.23"
      - uses: arduino/setup-task@v2
        with:
          version: 3.40.x
          repo-token: ${{ secrets.GITHUB_TOKEN }}
      - uses: arduino/setup-protoc@v3
        with:
          version: 29.3
          repo-token: ${{ secrets.GITHUB_TOKEN }}
      - name: Setup protoc
        run: go install google.golang.org/protobuf/cmd/protoc-gen-go@v1.36.10
      - name: Integration tests
        env:
          S2_ACCESS_TOKEN: ${{ secrets.S2_ACCESS_TOKEN }}
          S2_ACCOUNT_ENDPOINT: ${{ secrets.S2_ACCOUNT_ENDPOINT }}
          S2_BASIN_ENDPOINT: ${{ secrets.S2_BASIN_ENDPOINT }}
        run: task test:integration

  build-s2-lite:
    name: Build S2-lite
    uses: s2-streamstore/s2/.github/workflows/build-s2-lite.yml@main

  s2-lite-integration:
    name: S2-lite Integration
    needs: build-s2-lite
    uses: s2-streamstore/s2/.github/workflows/sdk-tests.yml@main
    with:
      server-binary: server
      server-args: "--port 8080"
      server-port: 8080
      sdks: |
        [
          {
            "name": "go",
            "repo": "${{ github.repository }}",
            "ref": "${{ github.ref }}",
            "lang": "go",
            "go-version": "1.23",
            "test_cmd": "go test -v -timeout 10m -count=1 -skip WithScope ./s2/..."
          }
        ]

  golangci-lint:
    name: GolangCI Lint
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: true
      - uses: actions/setup-go@v5
        with:
          go-version: "1.23"
      - name: Lint
        uses: golangci/golangci-lint-action@v7
        with:
          version: v2.1.6

  bento-integration:
    name: Bento Integration
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: true
          path: s2-sdk-go
      - uses: actions/checkout@v4
        with:
          repository: infiniteregrets/bento
          ref: m/update-s2-bentobox
          path: bento
      - uses: actions/setup-go@v5
        with:
          go-version: "1.23"
      - name: Setup bento with local s2-sdk-go
        working-directory: bento
        run: |
          go mod edit -replace github.com/s2-streamstore/s2-sdk-go=../s2-sdk-go
          go mod tidy
          go build -o bento ./cmd/bento
      - name: Create test basin
        env:
          S2_ACCESS_TOKEN: ${{ secrets.S2_ACCESS_TOKEN }}
        working-directory: s2-sdk-go
        run: |
          BASIN_NAME=$(go run ./s2-bentobox/testdata/setup create)
          echo "BASIN_NAME=$BASIN_NAME" >> $GITHUB_ENV
          echo "Created basin: $BASIN_NAME"
      - name: Test bento output (write to S2)
        env:
          S2_ACCESS_TOKEN: ${{ secrets.S2_ACCESS_TOKEN }}
        working-directory: bento
        run: |
          cat > test-output.yaml << EOF
          input:
            generate:
              mapping: |
                root.message = "bento-ci-test"
                root.count = counter()
              interval: 100ms
              count: 5
          output:
            s2:
              basin: ${{ env.BASIN_NAME }}
              stream: test-stream
              access_token: "\${S2_ACCESS_TOKEN}"
          EOF
          ./bento run test-output.yaml
      - name: Test bento input (read from S2)
        env:
          S2_ACCESS_TOKEN: ${{ secrets.S2_ACCESS_TOKEN }}
        working-directory: bento
        run: |
          cat > test-input.yaml << EOF
          cache_resources:
            - label: seq_cache
              memory: {}
          input:
            s2:
              basin: ${{ env.BASIN_NAME }}
              streams: test-stream
              access_token: "\${S2_ACCESS_TOKEN}"
              cache: seq_cache
          output:
            stdout: {}
          EOF
          timeout 10 ./bento run test-input.yaml 2>&1 | tee output.log || true
          # Verify we got the expected messages
          COUNT=$(grep -c "bento-ci-test" output.log || echo "0")
          if [ "$COUNT" -ge "5" ]; then
            echo "Success: Found $COUNT messages"
          else
            echo "Error: Expected at least 5 messages, got $COUNT"
            exit 1
          fi
      - name: Cleanup test basin
        if: always()
        env:
          S2_ACCESS_TOKEN: ${{ secrets.S2_ACCESS_TOKEN }}
        working-directory: s2-sdk-go
        run: go run ./s2-bentobox/testdata/setup delete ${{ env.BASIN_NAME }} || true
